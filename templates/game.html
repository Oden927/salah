<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Jeu en cours - Partie {{ game.name }}</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
        <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
        <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    </head>
    <body id="game-body" class="{{ game.current_phase }}">
        <div class="navbar">
            <div class="logo">Loup-Garou</div>
            <div class="nav-links">
                <a href="/">Accueil</a>
                <a href="/rules" class="active">Règles</a>
                <a href="/logout">Déconnexion</a>
            </div>
        </div>
<body id="game-body" class="{{ game.current_phase }}">
    <div class="content">
        <h1>Partie {{ game.name }}</h1>
        <p>Rôle attribué : 
            <span class="role-icon">
                {% if player.role == 'Loup-Garou' %}
                    <img src="{{ url_for('static', filename='images/werewolf.png') }}" alt="Loup-Garou" class="role-image">
                    Loup-Garou
                {% elif player.role == 'Voyante' %}
                    <img src="{{ url_for('static', filename='images/seer.png') }}" alt="Voyante" class="role-image">
                    Voyante
                {% elif player.role == 'Sorcière' %}
                    <img src="{{ url_for('static', filename='images/sorceress.png') }}" alt="Sorcière" class="role-image">
                    Sorcière
                {% elif player.role == 'Cupidon' %}
                    <img src="{{ url_for('static', filename='images/cupid.png') }}" alt="Cupidon" class="role-image">
                    Cupidon
                {% elif player.role == 'Fou' %}
                    <img src="{{ url_for('static', filename='images/fou.png') }}" alt="Fou" class="role-image">
                    Fou
                {% else %}
                    <img src="{{ url_for('static', filename='images/villager.png') }}" alt="Villageois" class="role-image">
                    Villageois
                {% endif %}

            </span>
        </p>
        
        <!-- Liste des joueurs -->
        <div id="players-list">
            <h2>Liste des joueurs</h2>
            <ul>
                {% for p in players %}
                <li class="player-item {% if p.eliminated %}eliminated{% endif %}">
                    {{ p.username }}
                </li>
                {% endfor %}
            </ul>
        </div>
        <div id="phase-timer-container">
            <h2 id="phase-title">Phase actuelle : {{ game.current_phase | capitalize }}</h2>
            <p id="phase-timer">Temps restant : 60 secondes</p>
        </div>
        
                <!-- Conteneur pour les notifications -->
        <div id="notification" class="notification" style="display: none;"></div>
                       <!-- Conteneur pour les animations de transition -->
        <div id="phase-transition" class="phase-transition"></div>
        

        <!-- Chat -->
        <div id="chat">
            <h2>Discussion</h2>
            <div id="messages" class="messages-container">
                <!-- Messages du chat s'afficheront ici -->
            </div>
            <input type="text" id="message-box" placeholder="Tapez votre message..." class="message-input">
            <button id="send-button" class="button">Envoyer</button>
        </div>
        <div id="voting-container" style="display: none;">
            <h2>Phase de Vote</h2>
            <p>Votez pour le joueur que vous souhaitez éliminer :</p>
            <div id="voting-options">
                {% for player in players %}
                    {% if not player.eliminated %}
                        <button class="vote-button" onclick="castVote('{{ player.user_id }}', '{{ player.username }}')">
                            Voter pour {{ player.username }}
                        </button>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        

        <!-- Vote des Loups-Garous (visible uniquement pour eux pendant la nuit) -->
        {% if player.role == "Loup-Garou" and game.current_phase == "night" %}
            <div id="werewolf-vote">
                <h2>Votez pour choisir une victime</h2>
                <div id="werewolf-voting-options">
                    {% for player in players %}
                        {% if not player.eliminated and player.role != "Loup-Garou" %}
                            <button class="vote-button" onclick="castWerewolfVote('{{ player.user_id }}', '{{ player.username }}')">
                                {{ player.username }}
                            </button>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- Action de Cupidon (visible uniquement pour Cupidon) -->
        {% if player.role == "Cupidon" and game.current_phase == "night" and not player.action_used %}
        <div id="cupid-action">
            <h2>Liez deux joueurs</h2>
            <form id="cupid-form">
                <label for="lover1">Premier joueur :</label>
                <select id="lover1" name="lover1">
                    {% for player in players %}
                        {% if player.user_id != session['user_id'] and not player.eliminated %}
                            <option value="{{ player.user_id }}">{{ player.username }}</option>
                        {% endif %}
                    {% endfor %}
                </select>

                <label for="lover2">Deuxième joueur :</label>
                <select id="lover2" name="lover2">
                    {% for player in players %}
                        {% if player.user_id != session['user_id'] and not player.eliminated %}
                            <option value="{{ player.user_id }}">{{ player.username }}</option>
                        {% endif %}
                    {% endfor %}
                </select>

                <button type="button" id="submit-cupid" class="button">Valider</button>
            </form>
        </div>
        {% endif %}

        <!-- Action de la Sorcière (visible uniquement pour la Sorcière) -->
        {% if player.role == "Sorcière" and game.current_phase == "night" %}
        <div id="witch-action">
            <h2>Actions de la Sorcière</h2>
            <form id="witch-form">
                <label for="heal-target">Sauver un joueur :</label>
                <select id="heal-target" name="heal-target">
                    {% for player in players %}
                        {% if not player.eliminated %}
                            <option value="{{ player.user_id }}">{{ player.username }}</option>
                        {% endif %}
                    {% endfor %}
                </select>

                <label for="poison-target">Tuer un joueur :</label>
                <select id="poison-target" name="poison-target">
                    {% for player in players %}
                        {% if not player.eliminated %}
                            <option value="{{ player.user_id }}">{{ player.username }}</option>
                        {% endif %}
                    {% endfor %}
                </select>

                <button type="button" id="heal-button" class="button">Utiliser la potion de guérison</button>
                <button type="button" id="poison-button" class="button">Utiliser la potion de poison</button>
            </form>
        </div>
        {% endif %}
             <!-- Action de la Voyante (visible uniquement pour la Voyante pendant la nuit) -->
        {% if player.role == "Voyante" and game.current_phase == "night" and not player.seer_used %}
        <div id="seer-action">
            <h2>Voir le rôle d'un joueur</h2>
            <form id="seer-form">
                <label for="seer-target">Choisissez un joueur :</label>
                <select id="seer-target" name="seer-target">
                    {% for player in players %}
                        {% if player.user_id != session['user_id'] and not player.eliminated %}
                            <option value="{{ player.user_id }}">{{ player.username }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
                <button type="button" id="seer-button" class="button">Révéler le rôle</button>
            </form>
        </div>
        {% endif %}
    </div>
    <ul>
        {% for player in players %}
            <li class="player-item {% if player.eliminated %}eliminated{% endif %}" data-user-id="{{ player.user_id }}">
                {{ player.username }}
            </li>
        {% endfor %}
    </ul>
            
    

    <script>
        const socket = io();
        const room = "game_{{ game.id }}";
        const username = "{{ session['username'] }}";

        // Rejoindre la salle du jeu
        socket.emit('join', { username: username, room: room });

        // Gestion des messages du chat
        socket.on('message', (data) => {
            const messagesDiv = document.getElementById('messages');
            const messageBlock = document.createElement('div');
            messageBlock.classList.add('message-block');
            messageBlock.innerHTML = `
                <strong>${data.username}</strong> <span>(${data.timestamp})</span>:
                <p>${data.message}</p>
            `;
            messagesDiv.appendChild(messageBlock);
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scroll automatique
        });

        // Envoi de messages
        const sendButton = document.getElementById('send-button');
        const messageBox = document.getElementById('message-box');
        sendButton.addEventListener('click', () => {
            const message = messageBox.value.trim();
            if (message) {
                socket.emit('message', { room: room, message: message });
                messageBox.value = ''; // Réinitialiser la boîte de message
            }
        });

        // Timer et phases
        let timer = 0;
        let timerInterval;

        // Met à jour l'affichage du timer
        function updateTimerDisplay(remainingTime) {
            const timerElement = document.getElementById('phase-timer');
            if (timerElement) {
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                timerElement.textContent = `Temps restant : ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            }
        }

        // Démarre le timer
        function startTimer(initialTime) {
            clearInterval(timerInterval); // Réinitialiser tout timer existant
            timer = initialTime;

            timerInterval = setInterval(() => {
                if (timer > 0) {
                    timer--;
                    updateTimerDisplay(timer);
                } else {
                    clearInterval(timerInterval);
                    alert("La phase est terminée !");
                }
            }, 1000);
        }

        // Affiche une animation de transition de phase
        function showPhaseTransition(message) {
            const phaseTransition = document.getElementById('phase-transition');
            if (phaseTransition) {
                phaseTransition.textContent = message;
                phaseTransition.classList.add('active');
                setTimeout(() => {
                    phaseTransition.classList.remove('active');
                }, 3000);
            }
        }

        // Met à jour la phase et démarre le timer
        function updatePhaseAndTimer(phase, remainingTime) {
            // Mettre à jour le titre de la phase
            const phaseTitle = document.getElementById('phase-title');
            if (phaseTitle) {
                const phaseNames = {
                    night: "🌙 Nuit",
                    day: "☀️ Jour",
                    voting: "🗳️ Vote"
                };
                phaseTitle.textContent = `Phase actuelle : ${phaseNames[phase] || "Inconnue"}`;
            }

            // Démarrer le timer
            startTimer(remainingTime);

            // Mettre à jour la classe du <body> pour changer le fond
            const body = document.getElementById('game-body');
            if (body) {
                body.className = phase; // Appliquer la classe correspondante
            }
        }

        // Recevoir l'état initial de la partie
        socket.emit('get_game_state', { game_id: "{{ game.id }}" });

        socket.on('game_state', (data) => {
            console.log("État initial de la partie :", data);
            updatePhaseAndTimer(data.current_phase, data.remaining_time);
            updateChatVisibility(data.current_phase, "{{ player.role }}");
        });

        // Gérer les changements de phase
        socket.on('phase_change', (data) => {
            console.log("Changement de phase :", data.new_phase);
            console.log("Joueurs actifs :", data.active_players);

            updateChatVisibility(data.new_phase, "{{ player.role }}");
            updatePhaseAndTimer(data.new_phase, data.remaining_time || 60);
            showPhaseTransition(data.notification || "Nouvelle phase...");

            const votingContainer = document.getElementById('voting-container');
            const votingOptions = document.getElementById('voting-options');

            if (data.new_phase === 'voting') {
                votingOptions.innerHTML = ''; // Réinitialise les options précédentes
                console.log("DEBUG: Joueurs actifs pour le vote :", data.active_players);

                if (data.active_players && Array.isArray(data.active_players)) {
                    data.active_players.forEach(player => {
                        const button = document.createElement('button');
                        button.textContent = `Voter pour ${player.username}`;
                        button.className = 'vote-button';
                        button.onclick = () => castVote(player.user_id, player.username);
                        votingOptions.appendChild(button);
                    });
                } else {
                    console.error("Erreur : Aucun joueur actif reçu.");
                    alert("Erreur : Impossible d'afficher les options de vote.");
                }

                votingContainer.style.display = 'block';
            } else {
                votingContainer.style.display = 'none';
            }
        });

       


        socket.on('player_eliminated', (data) => {
            alert(data.message || "Vous avez été éliminé !");
            window.location.href = "{{ url_for('eliminated_page', game_id=game.id) }}";
        });
        socket.on('redirect_to_elimination', (data) => {
            alert(data.message);
            window.location.href = "{{ url_for('eliminated_page', game_id=game.id) }}";
        });



        // Casting a vote (Loups-Garous seulement)
        let hasVotedl = false;
        let hasVoted = false;


        function castVote(victimId, victimName) {
            if (hasVoted) {
                alert("Vous avez déjà voté !");
                return;
            }

            socket.emit('vote', {room: room,victimId: victimId, gameId: "{{ game.id }}"  });
            hasVoted= true;
            alert(`Vous avez voté pour ${victimName}.`);
        }
        socket.on('vote_registered', (data) => {
            // Show voting progress
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = data.message;
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        });


        // Notification pour un vote
        socket.on('vote_notification', (data) => {
            alert(`${data.voter} a voté.`);
        });

        // Annonce du résultat du vote
        socket.on('vote_result', (data) => {
            if (data.eliminatedPlayer) {
                alert(`${data.eliminatedPlayer} a été éliminé.`);
            } else {
                alert("Aucun joueur n'a été éliminé, égalité des votes.");
            }
        });
        function castWerewolfVote(victimId, victimName) {
            if (hasVotedl) {
                alert("Vous avez déjà voté !");
                return;
            }

            console.log(`DEBUG: Envoi du vote pour la victime ID = ${victimId}`);
            socket.emit('werewolf_vote', {
                room: room,
                victimId: victimId
            });
            hasVotedl= true;

            // Afficher une notification au joueur
            alert(`Vous avez voté pour éliminer ${victimName}.`);
        }

        // Notifications pour les votes des Loups-Garous
        socket.on('werewolf_vote_result', (data) => {
            alert(`Résultat du vote : ${data.victim} a été choisi comme victime.`);
        });

        // Mise à jour de la liste des joueurs
        socket.on('player_eliminated', (data) => {
            const playerElement = document.getElementById(`player-${data.user_id}`);
            const playersList = document.getElementById('players-list');
            if (playerElement) {
                playerElement.classList.add('eliminated');
                playerElement.style.textDecoration = 'line-through';
                playerElement.style.color = 'red';
            }
            const playerItems = playersList.querySelectorAll('.player-item');
            playerItems.forEach(item => {
                if (item.textContent.trim() === data.username) {
                    item.classList.add('eliminated'); // Ajoute la classe 'eliminated' pour barrer
                    item.style.textDecoration = 'line-through'; // Style optionnel pour barrer immédiatement
                    item.style.color = 'red'; // Change la couleur pour indiquer l'élimination
                }
            });
            });
        function updateChatVisibility(phase, role) {
            const chatDiv = document.getElementById('chat');
            const messagesDiv = document.getElementById('messages');
            const messageBox = document.getElementById('message-box');
            const sendButton = document.getElementById('send-button');

            if (phase === 'night' && role !== 'Loup-Garou') {
                // Cache le chat pour les non-Loups-Garous
                if (chatDiv) chatDiv.style.display = 'none';
                if (messagesDiv) messagesDiv.style.display = 'none';
                if (messageBox) messageBox.disabled = true;
                if (sendButton) sendButton.disabled = true;
            } else {
                // Affiche le chat pour les autres phases ou pour les Loups-Garous
                if (chatDiv) chatDiv.style.display = 'block';
                if (messagesDiv) messagesDiv.style.display = 'block';
                if (messageBox) messageBox.disabled = false;
                if (sendButton) sendButton.disabled = false;
            }
        }




        function updateTimer() {
            if (timer > 0) {
                timer--;
                document.getElementById('timer').textContent = timer;
            } else {
                clearInterval(timerInterval);
                alert("La phase est terminée !");
            }
        }
                        // Action de Cupidon
        const cupidForm = document.getElementById('cupid-form');
        const submitCupid = document.getElementById('submit-cupid');
        if (submitCupid) {
            submitCupid.addEventListener('click', () => {
                const lover1 = document.getElementById('lover1').value;
                const lover2 = document.getElementById('lover2').value;

                if (lover1 === lover2) {
                    alert("Vous ne pouvez pas lier un joueur avec lui-même.");
                    return;
                }

                socket.emit('cupid_action', {
                    room: room,
                    lover1: lover1,
                    lover2: lover2
                });

                alert("Action effectuée. Vous êtes maintenant un Villageois.");
                document.getElementById('cupid-action').style.display = 'none';
            });
        }
        // Notification publique des amoureux
        socket.on('cupid_announcement', (data) => {
            const messagesDiv = document.getElementById('messages');
            const announcement = document.createElement('div');
            announcement.classList.add('message-block');
            announcement.innerHTML = `
                <strong>Système :</strong> ${data.lover1} et ${data.lover2} sont maintenant amoureux !
            `;
            messagesDiv.appendChild(announcement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
            // Actions de la Sorcière
        const healButton = document.getElementById('heal-button');
        const poisonButton = document.getElementById('poison-button');

        if (healButton) {
            healButton.addEventListener('click', () => {
                const targetId = document.getElementById('heal-target').value;
                socket.emit('witch_action', {
                    room: room,
                    action: 'heal',
                    targetId: targetId
                });
                alert("Potion de guérison utilisée.");
                document.getElementById('witch-action').style.display = 'none';
            });
        }

        if (poisonButton) {
            poisonButton.addEventListener('click', () => {
                const targetId = document.getElementById('poison-target').value;
                socket.emit('witch_action', {
                    room: room,
                    action: 'poison',
                    targetId: targetId
                });
                alert("Potion de poison utilisée.");
                document.getElementById('witch-action').style.display = 'none';
            });
        }
                // Action de la Voyante
                const seerButton = document.getElementById('seer-button');
        if (seerButton) {
            seerButton.addEventListener('click', () => {
                const targetId = document.getElementById('seer-target').value;

                socket.emit('seer_action', {
                    room: room,
                    targetId: targetId
                });

                alert("Vous avez utilisé votre pouvoir pour voir le rôle du joueur.");
                document.getElementById('seer-action').style.display = 'none';
            });
        }

        // Notification privée pour la Voyante
        socket.on('seer_notification', (data) => {
            alert(`Notification privée : Le rôle de ${data.targetName} est ${data.role}.`);
        });

            // Notifications
        socket.on('cupid_announcement', (data) => {
            alert(`${data.lover1} et ${data.lover2} sont maintenant amoureux.`);
        });

        socket.on('witch_action', (data) => {
            alert(data.message);
        });
    </script>
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 800px;
            margin: auto;
        }
        #players-list ul {
            list-style: none;
            padding: 0;
        }
        .player-item {
            font-size: 1.2rem;
            margin: 5px 0;
        }
        .player-item.eliminated {
            text-decoration: line-through;
            color: red;
        }
        #chat {
            margin-top: 20px;
        }
        .messages-container {
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            background-color: #fff;
        }
        .message-block {
            margin-bottom: 10px;
        }
        .message-input {
            width: 80%;
            padding: 10px;
            margin-right: 10px;
        }
        .button, .vote-button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        .phase-transition {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 2em;
            padding: 20px 40px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
        }

        .fade-in {
            animation: fadeInOut 3s ease-in-out;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        .role-image {
            width: 40px;
            height: 40px;
            vertical-align: middle;
            margin-right: 8px;
        }

        .role-icon {
            display: inline-flex;
            align-items: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        #role-container {
            margin-bottom: 20px;
            text-align: center;
        }

        .phase-transition {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            font-size: 2.5rem;
            padding: 30px 50px;
            border-radius: 15px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: transform 0.5s ease, opacity 0.5s ease;
        }

        .phase-transition.active {
            display: block;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        #phase-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    background-size: cover;
    background-position: center;
    transition: background-image 1s ease-in-out;
    }

    body.day #phase-background {
        background-image: url('{{ url_for("static", filename="images/village.jpeg") }}');
    }

    body.voting #phase-background {
        background-image: url('{{ url_for("static", filename="images/village.jpeg") }}');
    }

    body.night #phase-background {
        background-image: url('{{ url_for("static", filename="images/forest.jpeg") }}');
    }

    </style>
</body>
</html>
