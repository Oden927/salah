<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeu en cours - Partie {{ game.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <div class="content">
        <h1>Partie {{ game.name }}</h1>
        <p>Rôle attribué : {{ roles | selectattr('player_id', 'equalto', session['user_id']) | map(attribute='role') | first }}</p>

        <!-- Minuteur -->
        <p id="timer">Temps restant : 5:00</p>

        <!-- Chat pour la discussion -->
        <div id="chat" class="chat-container">
            <h2>Discussion</h2>
            <div id="messages" class="messages-container">
                <!-- Les messages s'afficheront ici -->
            </div>
            <input type="text" id="message-box" placeholder="Tapez votre message..." class="message-input">
            <button id="send" class="auth-button">Envoyer</button>
        </div>

        <!-- Section de vote -->
        <div id="voting" style="display: none;">
            <h2>Votez pour éliminer un joueur</h2>
            <div id="voting-options">
                <!-- Les options de vote seront générées ici -->
            </div>
        </div>
    </div>
    <p id="phase">Phase actuelle : {{ game.current_phase }}</p>

    <script>
       const socket = io();
        const username = "{{ session['username'] }}";
        const room = "game_{{ game.id }}";
        let timerInterval;

        // Join room
        socket.emit('join', { username: username, room: room });

        function updateTimer(remainingTime) {
            const timerDisplay = document.getElementById('timer');
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            timerDisplay.textContent = `Temps restant : ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            
            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                startVoting();
            }
        }

        function initializeTimer() {
            // Initial timer fetch
            fetch(`/game_timer/{{ game.id }}`)
                .then(response => response.json())
                .then(data => {
                    updateTimer(data.remaining_time);
                    
                    // Set up periodic updates
                    timerInterval = setInterval(() => {
                        fetch(`/game_timer/{{ game.id }}`)
                            .then(response => response.json())
                            .then(data => {
                                updateTimer(data.remaining_time);
                            })
                            .catch(console.error);
                    }, 1000);
                })
                .catch(console.error);
        }

        // Initialize timer when page loads
        initializeTimer();

        // Rest of the code remains the same
        // Phase de vote
        function startVoting() {
            document.getElementById('chat').style.display = 'none';
            document.getElementById('voting').style.display = 'block';

            const votingOptions = document.getElementById('voting-options');
            votingOptions.innerHTML = '';

            const players = JSON.parse('{{ players | tojson | safe }}');
            players.forEach(player => {
                const voteButton = document.createElement('button');
                voteButton.textContent = player.username;
                voteButton.classList.add('vote-button');
                voteButton.addEventListener('click', () => castVote(player.user_id));
                votingOptions.appendChild(voteButton);
            });
        }

        // Soumettre un vote
        function castVote(votedUserId) {
            socket.emit('vote', { votedUserId: votedUserId, room: room });
        }

        // Écouter le résultat du vote
        socket.on('vote_result', (data) => {
            alert(`${data.eliminatedPlayer} a été éliminé !`);
            location.reload(); // Recharge la page pour continuer
        });

        // Gestion des messages
        const sendButton = document.getElementById('send');
        const messageBox = document.getElementById('message-box');
        const messagesDiv = document.getElementById('messages');

        sendButton.addEventListener('click', () => {
            const message = messageBox.value.trim();
            const phase = "{{ game.current_phase }}";  // Phase actuelle depuis le serveur
            const role = "{{ player.role }}";  // Rôle du joueur actuel

            if (message) {
                // Pendant la nuit, seuls les Loups-Garous peuvent envoyer des messages
                if (phase === "night" && role !== "Loup-Garou") {
                    alert("Vous ne pouvez pas parler pendant la nuit !");
                    return;
                }

                socket.emit('message', { username: username, message: message, room: room });
                messageBox.value = '';
            }
        });

        // Réception des messages
        socket.on('message', (data) => {
            const phase = "{{ game.current_phase }}";
            const role = "{{ player.role }}";

            // Pendant la nuit, seuls les Loups-Garous voient les messages de leur chat
            if (phase === "night" && role !== "Loup-Garou" && data.role === "Loup-Garou") {
                return; // Ignorer les messages de la discussion des Loups-Garous
            }

            // Afficher le message
            const msg = document.createElement('div');
            msg.classList.add('message-block');
            msg.innerHTML = `
                <div class="message-header">
                    <strong>${data.username || "Utilisateur inconnu"}</strong>
                    <span>${data.timestamp || new Date().toLocaleTimeString()}</span>
                </div>
                <div class="message-content">${data.message || "Message non disponible"}</div>
            `;
            messagesDiv.appendChild(msg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });




        socket.on('phase_change', (data) => {
            if (data.game_id == "{{ game.id }}") {
                const phaseElement = document.getElementById('phase');
                phaseElement.textContent = `Phase actuelle : ${data.new_phase}`;

                if (data.new_phase === 'night') {
                    alert("C'est la nuit. Les Loups-Garous agissent.");
                } else if (data.new_phase === 'day') {
                    alert("C'est le jour. Les joueurs peuvent voter.");
                    startVoting();  // Démarrer la phase de vote
                }
            }
        });


        socket.on('message', (data) => {
            const msg = document.createElement('div');
            msg.classList.add('message-block');
            msg.innerHTML = `
                <div class="message-header">
                    <strong>${data.username || "Utilisateur inconnu"}</strong>
                    <span>${data.timestamp || new Date().toLocaleTimeString()}</span>
                </div>
                <div class="message-content">${data.message || "Message non disponible"}</div>
            `;
            messagesDiv.appendChild(msg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
    </script>

</body>
</html>
